services:
  anvil:
    image: ghcr.io/foundry-rs/foundry:nightly
    container_name: bc-fl-anvil
    entrypoint: ["anvil"]
    command: ["--host", "0.0.0.0", "--port", "8545", "--chain-id", "31337"]
    ports:
      - "8545:8545"
    networks:
      - bcfl_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cast chain-id --rpc-url http://127.0.0.1:8545 >/dev/null 2>&1 || exit 1"]
      interval: 3s
      timeout: 3s
      retries: 30
      start_period: 2s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bc-fl-platform-backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend/.data:/code/.data
    environment:
      - DB_PATH=/code/.data/bcfl.db
      - AGENT_REG_SECRET=dev-secret
      - AGENT_CALL_TIMEOUT=8

      - BC_ENABLED=1
      - BC_RPC_URL=http://anvil:8545
      - BC_CHAIN_ID=31337
      - BC_PRIVATE_KEY=${BC_PRIVATE_KEY}

      - BC_RECEIPT_CONTRACT_ADDRESS=${BC_RECEIPT_CONTRACT_ADDRESS}
      - BC_RECEIPT_CONTRACT_ABI_PATH=/code/app/abi/ReceiptRegistry.json

      - BC_CONSENT_CONTRACT_ADDRESS=${BC_CONSENT_CONTRACT_ADDRESS}
      - BC_CONSENT_CONTRACT_ABI_PATH=/code/app/abi/ConsentRegistry.json

      - PATIENT_PORTAL_SECRET=PATIENT_SECRET_123

      - BC_CONTRACT_ADDRESS=${BC_RECEIPT_CONTRACT_ADDRESS}
      - BC_CONTRACT_ABI_PATH=/code/app/abi/ReceiptRegistry.json

      - HOSPITAL_INVITE_CODE=HOSPITAL2026
      - BIOBANK_INVITE_CODE=BIOBANK2026
      - ADMIN_INVITE_CODE=ADMIN-security
    depends_on:
      anvil:
        condition: service_healthy
    networks:
      - bcfl_net
    restart: unless-stopped

  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: bc-fl-platform-ui
    ports:
      - "8501:8501"
    depends_on:
      - backend
    environment:
      - API_BASE_URL=http://backend:8000/api/v1
      - AGENT_REG_SECRET=dev-secret
    networks:
      - bcfl_net
    restart: unless-stopped

  hospital_a_agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: bc-fl-hospital-a-agent
    environment:
      - AGENT_REG_SECRET=dev-secret
      - ORCHESTRATOR_BASE_URL=http://backend:8000/api/v1
      - NODE_NAME="Hospital A Agent"
      - HOSPITAL_ORG=HospitalA
      - PUBLIC_BASE_URL=http://hospital_a_agent:9001

      - PATIENT_PORTAL_SECRET=PATIENT_SECRET_123
      - CONSENT_FILTER_ENABLED=0
      - PATIENT_ID_COLUMN=patient_id
    volumes:
      - ./hospital_nodes/hospital_a/data:/data
    networks:
      - bcfl_net
    restart: unless-stopped

  hospital_b_agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: bc-fl-hospital-b-agent
    environment:
      - AGENT_REG_SECRET=dev-secret
      - ORCHESTRATOR_BASE_URL=http://backend:8000/api/v1
      - NODE_NAME="Hospital B Agent"
      - HOSPITAL_ORG=HospitalB
      - PUBLIC_BASE_URL=http://hospital_b_agent:9001

      - PATIENT_PORTAL_SECRET=PATIENT_SECRET_123
      - CONSENT_FILTER_ENABLED=0
      - PATIENT_ID_COLUMN=patient_id
    volumes:
      - ./hospital_nodes/hospital_b/data:/data
    networks:
      - bcfl_net
    restart: unless-stopped

networks:
  bcfl_net:
    name: bcfl_net
    driver: bridge

