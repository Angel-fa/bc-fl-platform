services:
  anvil:
    image: ghcr.io/foundry-rs/foundry:nightly
    container_name: bc-fl-anvil
    entrypoint: ["anvil"]
    command: ["--host", "0.0.0.0", "--port", "8545", "--chain-id", "31337"]
    ports:
      - "8545:8545"
    networks:
      - bcfl_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cast chain-id --rpc-url http://127.0.0.1:8545 >/dev/null 2>&1 || exit 1"]
      interval: 3s
      timeout: 3s
      retries: 30
      start_period: 2s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: bc-fl-platform-backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend/.data:/code/.data
    environment:
      - DB_PATH=/code/.data/bcfl.db
      - AGENT_REG_SECRET=dev-secret
      - AGENT_CALL_TIMEOUT=8

      - BC_ENABLED=1
      - BC_RPC_URL=http://anvil:8545
      - BC_CHAIN_ID=31337
      - BC_PRIVATE_KEY=${BC_PRIVATE_KEY}

      # Receipt registry (audit anchoring)
      - BC_RECEIPT_CONTRACT_ADDRESS=${BC_RECEIPT_CONTRACT_ADDRESS}
      - BC_RECEIPT_CONTRACT_ABI_PATH=/code/app/abi/ReceiptRegistry.json

      # Consent registry (patient consents)
      - BC_CONSENT_CONTRACT_ADDRESS=${BC_CONSENT_CONTRACT_ADDRESS}
      - BC_CONSENT_CONTRACT_ABI_PATH=/code/app/abi/ConsentRegistry.json

      # Patient portal secret (shared with agents if needed)
      - PATIENT_PORTAL_SECRET=PATIENT_SECRET_123

      # Legacy vars used by current blockchain_service.py (anchors receipts)
      - BC_CONTRACT_ADDRESS=${BC_RECEIPT_CONTRACT_ADDRESS}
      - BC_CONTRACT_ABI_PATH=/code/app/abi/ReceiptRegistry.json

      # Invite codes for registration
      - HOSPITAL_INVITE_CODE=HOSPITAL2026
      - BIOBANK_INVITE_CODE=BIOBANK2026
    depends_on:
      anvil:
        condition: service_healthy
    networks:
      - bcfl_net
    restart: unless-stopped

  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: bc-fl-platform-ui
    ports:
      - "8501:8501"
    depends_on:
      - backend
    environment:
      - API_BASE_URL=http://backend:8000/api/v1
      - AGENT_REG_SECRET=dev-secret
    networks:
      - bcfl_net
    restart: unless-stopped

  hospital_a_agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: bc-fl-hospital-a-agent
    environment:
      - AGENT_REG_SECRET=dev-secret
      - ORCHESTRATOR_BASE_URL=http://backend:8000/api/v1
      - NODE_NAME=Hospital A Agent
      - HOSPITAL_ORG=HospitalA
      - PUBLIC_BASE_URL=http://hospital_a_agent:9001

      - PATIENT_PORTAL_SECRET=PATIENT_SECRET_123
      - CONSENT_FILTER_ENABLED=0
      - PATIENT_ID_COLUMN=patient_id
    volumes:
      - ./hospital_nodes/hospital_a/data:/data
    networks:
      - bcfl_net
    restart: unless-stopped

  hospital_b_agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: bc-fl-hospital-b-agent
    environment:
      - AGENT_REG_SECRET=dev-secret
      - ORCHESTRATOR_BASE_URL=http://backend:8000/api/v1
      - NODE_NAME=Hospital B Agent
      - HOSPITAL_ORG=HospitalB
      - PUBLIC_BASE_URL=http://hospital_b_agent:9001

      - PATIENT_PORTAL_SECRET=PATIENT_SECRET_123
      - CONSENT_FILTER_ENABLED=0
      - PATIENT_ID_COLUMN=patient_id
    volumes:
      - ./hospital_nodes/hospital_b/data:/data
    networks:
      - bcfl_net
    restart: unless-stopped

networks:
  bcfl_net:
    name: bcfl_net
    driver: bridge

"""

Î— Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± Î±Ï€Î¿Ï„ÎµÎ»ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Docker services: 
backend Î³Î¹Î± ÏƒÏ…Î½Ï„Î¿Î½Î¹ÏƒÎ¼ÏŒ, UI Î³Î¹Î± Î±Î»Î»Î·Î»ÎµÏ€Î¯Î´ÏÎ±ÏƒÎ·, agents Î³Î¹Î± Ï„Î¿Ï€Î¹ÎºÎ¿ÏÏ‚ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿ÏÏ‚, 
lockchain Î³Î¹Î± audit/consent ÎºÎ±Î¹ volumes Î³Î¹Î± Î±Ï€Î¿Î¼ÏŒÎ½Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½, 
ÏÏƒÏ„Îµ Î½Î± Ï…Ï€Î¿ÏƒÏ„Î·ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï€Î»Î®ÏÏ‰Ï‚ federated learning Î¼Îµ Î­Î¼Ï†Î±ÏƒÎ· ÏƒÏ„Î·Î½ Î¹Î´Î¹Ï‰Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±.

Î¤Î¿ docker-compose Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Ï‰Ï‚ orchestrator Ï…Ï€Î¿Î´Î¿Î¼Î®Ï‚. 
Î”ÎµÎ½ Ï…Î»Î¿Ï€Î¿Î¹ÎµÎ¯ ÎºÎ±Î¼Î¯Î± ÎµÏ€Î¹Ï‡ÎµÎ¹ÏÎ·ÏƒÎ¹Î±ÎºÎ® Î»Î¿Î³Î¹ÎºÎ®, Î±Î»Î»Î¬ Ï€ÎµÏÎ¹Î³ÏÎ¬Ï†ÎµÎ¹ 
Ï€ÏÏ‚ ÏŒÎ»Î± Ï„Î± Î±Î½ÎµÎ¾Î¬ÏÏ„Î·Ï„Î± Docker services â€” backend, UI, agents ÎºÎ±Î¹ blockchain â€” 
ÎµÎºÎºÎ¹Î½Î¿ÏÎ½, ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¿ÏÎ½ ÎºÎ±Î¹ ÏƒÏ…Î½Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÎµ Î­Î½Î± ÎµÎ½Î¹Î±Î¯Î¿, Î±Î½Î±Ï€Î±ÏÎ±Î³ÏÎ³Î¹Î¼Î¿ Ï€ÎµÏÎ¹Î²Î¬Î»Î»Î¿Î½.Â»

ÎÎ±Î¹ â€” Î±ÎºÏÎ¹Î²ÏÏ‚ Î±Ï…Ï„ÏŒ.
ÎšÎ±Î¹ Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï„Î¿ ÎµÎ¾Î·Î³Î®ÏƒÎµÎ¹Ï‚ Ï€Î¿Î»Ï ÎºÎ±Î¸Î±ÏÎ¬ Ï‰Ï‚ ÎµÎ¾Î®Ï‚:

â¸»

Î¤Î¹ ÎºÎ¬Î½ÎµÎ¹ Ï„Î¿ docker-compose.yml

Î¤Î¿ docker-compose Î´ÎµÎ½ Ï…Î»Î¿Ï€Î¿Î¹ÎµÎ¯ Î»Î¿Î³Î¹ÎºÎ® ÎµÏ†Î±ÏÎ¼Î¿Î³Î®Ï‚.
ÎŸ ÏÏŒÎ»Î¿Ï‚ Ï„Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÎºÎ±Î¸Î±ÏÎ¬ Î¿ÏÎ³Î±Î½Ï‰Ï„Î¹ÎºÏŒÏ‚ ÎºÎ±Î¹ Ï…Ï€Î¿Î´Î¿Î¼Î®Ï‚.

Î£Îµ Î¼Î¯Î± Ï€ÏÏŒÏ„Î±ÏƒÎ· (Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·-ÎºÎ»ÎµÎ¹Î´Î¯):

Â«Î¤Î¿ docker-compose Î¿ÏÎ¯Î¶ÎµÎ¹, ÎµÎºÎºÎ¹Î½ÎµÎ¯ ÎºÎ±Î¹ ÏƒÏ…Î½Î´Î­ÎµÎ¹ ÏŒÎ»Î± Ï„Î± Î±Î½ÎµÎ¾Î¬ÏÏ„Î·Ï„Î± services Ï„Î·Ï‚ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î±Ï‚ ÏÏƒÏ„Îµ Î½Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¿ÏÎ½ Ï‰Ï‚ Î­Î½Î± ÎµÎ½Î¹Î±Î¯Î¿ ÏƒÏÏƒÏ„Î·Î¼Î±.Â»

â¸»

Î Î¹Î¿ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÎ¬ â€“ Ï„Î¹ ÎºÎ¬Î½ÎµÎ¹ ÏƒÏ„Î·Î½ Ï€ÏÎ¬Î¾Î·

1. Î•ÎºÎºÎ¹Î½ÎµÎ¯ ÏŒÎ»Î± Ï„Î± services Î¼Î±Î¶Î¯

Î§Ï‰ÏÎ¯Ï‚ docker-compose Î¸Î± Î­Ï€ÏÎµÏ€Îµ:
	â€¢	Î½Î± Ï‡Ï„Î¯ÏƒÎµÎ¹Ï‚ ÎºÎ¬Î¸Îµ image Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬
	â€¢	Î½Î± Ï„ÏÎ­Î¾ÎµÎ¹Ï‚ ÎºÎ¬Î¸Îµ container Î¼Îµ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± commands
	â€¢	Î½Î± Î¸Ï…Î¼Î¬ÏƒÎ±Î¹ ports, volumes, secrets

ÎœÎµ docker-compose:

docker-compose up

ÎºÎ±Î¹ ÏŒÎ»Î· Î· Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î± ÏƒÎ·ÎºÏÎ½ÎµÏ„Î±Î¹.

â¸»

2. Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ ÎºÎ¿Î¹Î½ÏŒ Î´Î¯ÎºÏ„Ï…Î¿ (network)

networks:
  bcfl_net:
    driver: bridge

Î‘Ï…Ï„ÏŒ ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹:
	â€¢	ui â†’ backend
	â€¢	backend â†’ agents
	â€¢	backend â†’ anvil
	â€¢	agents â†’ backend

ÏŒÎ»Î± Î¼Î­ÏƒÏ‰ DNS Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚ container (Ï€.Ï‡. http://backend:8000).

ğŸ‘‰ Î”ÎµÎ½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹ IPs, Î¬ÏÎ± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î±Î¸ÎµÏÏŒ ÎºÎ±Î¹ portable.

â¸»

3. Î£Ï…Î½Î´Î­ÎµÎ¹ Ï„Î± services Î»Î¿Î³Î¹ÎºÎ¬

Î Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î±:
	â€¢	Î¤Î¿ UI:

API_BASE_URL=http://backend:8000/api/v1

	â€¢	ÎŸÎ¹ agents:

ORCHESTRATOR_BASE_URL=http://backend:8000/api/v1

	â€¢	Î¤Î¿ backend:

BC_RPC_URL=http://anvil:8545

ğŸ‘‰ Î”Î·Î»Î±Î´Î®:

Â«Î¤Î¿ docker-compose ÎºÎ±Î¸Î¿ÏÎ¯Î¶ÎµÎ¹ Ï€Î¿Î¹Î¿Ï‚ Î¼Î¹Î»Î¬ÎµÎ¹ Î¼Îµ Ï€Î¿Î¹Î¿Î½ ÎºÎ±Î¹ Ï€ÏÏ‚.Â»

â¸»

4. Î•Ï€Î¹Î²Î¬Î»Î»ÎµÎ¹ ÏƒÎµÎ¹ÏÎ¬ ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·Ï‚

depends_on:
  anvil:
    condition: service_healthy

Î£Î·Î¼Î±Î¯Î½ÎµÎ¹:
	â€¢	Ï€ÏÏÏ„Î± blockchain
	â€¢	Î¼ÎµÏ„Î¬ backend
	â€¢	Î¼ÎµÏ„Î¬ UI / agents

Î§Ï‰ÏÎ¯Ï‚ Î±Ï…Ï„ÏŒ, Ï„Î¿ backend Î¸Î± Î±Ï€Î¿Ï„ÏÎ³Ï‡Î±Î½Îµ ÏƒÏ„Î¿ startup.

â¸»

5. Î”Î¹Î±Ï‡Ï‰ÏÎ¯Î¶ÎµÎ¹ ÏÏŒÎ»Î¿Ï…Ï‚ Î¼Îµ Ï„Î¿ Î¯Î´Î¹Î¿ image

ÎˆÏ‡ÎµÎ¹Ï‚ Î­Î½Î± agent image, Î±Î»Î»Î¬:

hospital_a_agent
hospital_b_agent

Î¼Îµ Î´Î¹Î±Ï†Î¿ÏÎµÏ„Î¹ÎºÎ¬:
	â€¢	org
	â€¢	volumes
	â€¢	public URLs

ğŸ‘‰ Î‘Ï…Ï„ÏŒ Î±Ï€Î¿Î´ÎµÎ¹ÎºÎ½ÏÎµÎ¹ federated Î±ÏÏ‡Î¹Ï„ÎµÎºÏ„Î¿Î½Î¹ÎºÎ®.

â¸»

6. ÎŸÏÎ¯Î¶ÎµÎ¹ Ï„Î¹ ÎµÎ¯Î½Î±Î¹ persistent

ÎœÎµ volumes:
	â€¢	DB
	â€¢	datasets

Î§Ï‰ÏÎ¯Ï‚ docker-compose:
	â€¢	Î¸Î± Ï‡Î¬Î½Î¿Î½Ï„Î±Î½ ÏƒÎµ ÎºÎ¬Î¸Îµ restart.


"""